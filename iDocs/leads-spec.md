# Advanced Leads Module Specification (ISP-Focused)

## 1. Core Purpose

The **Leads** module is an advanced system designed specifically for Internet Service Providers (ISPs) to manage the entire lifecycle of a potential customer. It captures, tracks, and nurtures leads from initial contact to conversion, with a seamless handover to active customer status.

The primary goals are:
- To provide a centralized database for all potential customers.
- To track lead sources effectively for better marketing and sales strategy.
- To streamline the follow-up process through status management and assignments.
- **To automate the creation of a MikroTik user when a lead is converted to a customer.**

---

## 2. Lead Sources

Leads can originate from various channels. The system must allow for the clear categorization of lead sources to analyze their effectiveness.

- **Caretaker/House Manager:** Referrals from building managers.
- **Field Sales:** Leads generated by field sales agents.
- **Referral:** Leads from existing customers or partners.
- **Website:** Inquiries from the company website's contact form.
- **WhatsApp/SMS:** Leads originating from messaging platforms.
- **Manual Entry:** Leads added directly by staff.

---

## 3. UI Flow & Functionality

### 3.1. Add New Lead

A form to capture detailed information about a new lead.

**Form Fields:**
- **Lead Name:** `string` (e.g., "John Doe") - *Optional*
- **Phone Number:** `string` - *Required, Unique*
- **Lead Source:** `dropdown` (Caretaker/House Manager, Field Sales, Referral, Website, WhatsApp/SMS, Manual Entry) - *Required*
- **Desired Package:** `dropdown` (Should populate from existing packages) - *Optional*
- **Current ISP (if any):** `string` - *Optional*
- **Reason for Interest/Dissatisfaction:** `textarea` - *Optional* (e.g., "Current provider is unreliable," "Looking for faster speeds")
- **Brought In By:** `string` (manual text input, e.g., "John Doe") - *Optional*
- **Brought In By Contact:** `string` (manual text input for phone number) - *Optional*
- **Agreed Installation Fee (KES):** `number` - *Optional*
- **Agreed Monthly Subscription (KES):** `number` - *Optional*
- **Total Amount (KES):** `number` - *Read-only, auto-calculated (`Agreed Installation Fee` + `Agreed Monthly Subscription`)*
- **Customer Has Router:** `checkbox`
    - **Router Type:** `string` (manual text input, appears if checkbox is checked) - *Optional*
- **Follow-up Date:** `date` - *Optional*

### 3.2. View All Leads

A comprehensive dashboard to view and manage all leads.

**Dashboard / Stats Cards:**
- **Total Leads:** A count of all leads in the system.
- **New Leads (This Month):** A count of all leads created in the current calendar month.
- **Total Converted Leads:** A count of all leads with a 'Converted' status.

**Leads Over Time Chart:**
- **Type:** Area Chart
- **X-Axis:** Months (Jan, Feb, Mar, etc.)
- **Y-Axis:** Number of Leads
- **Data Series 1 (Area):** Total new leads created in each month.
- **Data Series 2 (Line/Overlay):** Total converted leads in each month.
- **Filter:** A dropdown to select the year to display data for.

**Display:** A table with the following columns:
- Lead Name
- Phone Number
- Lead Source
- Status
- Brought In By
- Follow-up Date
- Date Created
- Actions

**Filtering and Searching:**
- Filter by `Status`, `Lead Source`, `Brought In By`.
- Search by `Lead Name`, `Phone Number`.

### 3.3. Lead Status Management

The status of a lead is crucial for tracking its progress. The following statuses should be available:

- **New:** A newly created lead, not yet contacted.
- **Contacted:** The lead has been contacted, awaiting feedback.
- **Interested:** The lead has shown interest and is considering a package.
- **Site Survey Scheduled:** A technician is scheduled to visit the location.
- **Converted:** The lead has agreed to become a customer.
- **Not Interested:** The lead has declined the service.
- **Future Prospect:** The lead is not ready now but may be in the future.

**Actions on Status Change:**
- Changing the status should be a logged event, showing which user changed it and when.
- **When status is changed to `Converted`:**
    - A modal/dialog should appear, giving the user the option to create a MikroTik user.

---

## 4. The "Convert to Customer" Workflow

This is the most critical feature of the advanced leads module.

**Trigger:** A user with the appropriate permissions changes a lead's status to **`Converted`**.

**Process:**
1.  **Confirmation Dialog:** A dialog box appears, summarizing the lead's information.
2.  **MikroTik User Option:** The dialog will contain a checkbox: **"Create MikroTik User?"**
    - **If checked:** The form for creating a MikroTik user is displayed.
        - **Username:** `string` (auto-generated or editable, e.g., from the lead's name)
        - **Password:** `string` (auto-generated, with an option to view/change)
        - **Service/Package:** `dropdown` (pre-filled from the lead's `Desired Package`, but editable)
        - **Router:** `dropdown` (list of available MikroTik routers) - *Required*
        - **IP Address:** `string` (optional, can be auto-assigned)
    - **If not checked:** The user can simply save the status change.
3.  **API Call (if creating user):** Upon submission of the form, the system will make an API call to the backend.
    - `POST /api/mikrotik/users` (or a similar endpoint) with the user details.
4.  **Feedback:**
    - **Success (with user creation):** A success message is displayed, and the lead is now considered a customer, linked to the new MikroTik user. The lead's status is locked as `Converted`.
    - **Success (without user creation):** A success message is displayed, and the lead's status is `Converted`.
    - **Failure:** An error message is displayed if the MikroTik user creation fails (e.g., router not reachable, invalid details), and the lead's status remains `Interested` or reverts to a pre-conversion state.

---

## 5. API Endpoints

- **`GET /api/leads`**: Retrieve all leads with filtering and search capabilities.
- **`GET /api/leads/:id`**: Get a single lead by its ID.
- **`POST /api/leads`**: Create a new lead.
- **`PUT /api/leads/:id`**: Update a lead's details (including status).
- **`DELETE /api/leads/:id`**: Delete a lead.
- **`POST /api/leads/convert/:id`**: The special endpoint to handle the "Convert to Customer" workflow, which internally calls the MikroTik user creation endpoint.

---

## 6. Data Model (Example)

```json
{
  "_id": "lead_123",
  "name": "Jane Smith",
  "phoneNumber": "+254722000111",
  "leadSource": "Caretaker",
  "unitNumber": "A5",
  "location": "Westlands, Nairobi",
  "desiredPackage": {
    "_id": "package_789",
    "name": "20 Mbps Home"
  },
  "currentIsp": "Zuku",
  "notes": "Complaining about frequent downtime.",
  "status": "Interested",
  "assignedTo": {
    "_id": "user_abc",
    "name": "Tech Mark"
  },
  "followUpDate": "2025-09-20T00:00:00Z",
  "statusHistory": [
    {
      "status": "New",
      "changedBy": "user_xyz",
      "changedAt": "2025-09-18T10:00:00Z"
    },
    {
      "status": "Contacted",
      "changedBy": "user_abc",
      "changedAt": "2025-09-18T14:30:00Z"
    },
    {
      "status": "Interested",
      "changedBy": "user_abc",
      "changedAt": "2025-09-19T11:00:00Z"
    }
  ],
  "isConverted": false,
  "mikrotikUser": {
    "_id": "mikrotik_user_def" // Populated on conversion
  },
  "createdAt": "ISODate",
  "updatedAt": "ISODate"
}
```
